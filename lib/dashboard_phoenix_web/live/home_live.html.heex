<div class="min-h-screen flex flex-col" id="panel-state-container" phx-hook="PanelState">
  <!-- Compact Header -->
  <div class="glass-panel rounded-lg px-4 py-2 flex items-center justify-between mb-3">
    <div class="flex items-center space-x-4">
      <h1 class="text-sm font-bold tracking-widest text-base-content">SYSTEMATIC</h1>
      <span class="text-[10px] text-base-content/60 font-mono">AGENT CONTROL</span>
      
      <!-- Theme Toggle -->
      <button
        id="theme-toggle"
        phx-hook="ThemeToggle"
        class="p-1.5 rounded-lg bg-base-content/10 hover:bg-base-content/20 transition-colors"
        title="Toggle light/dark mode"
      >
        <svg class="sun-icon w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg class="moon-icon w-4 h-4 text-indigo-400" style="display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>
    </div>
    
    <!-- Compact Stats -->
    <div class="flex items-center space-x-6 text-xs font-mono">
      <div class="flex items-center space-x-2">
        <span class="text-base-content/50">Agents:</span>
        <span class="text-success font-bold"><%= @agent_sessions_count %></span>
      </div>
      <div class="flex items-center space-x-2">
        <span class="text-base-content/50">Events:</span>
        <span class="text-primary font-bold"><%= @agent_progress_count %></span>
      </div>
      <%= if @coding_agent_pref == :opencode do %>
        <div class="flex items-center space-x-2">
          <span class="text-base-content/50">ACP:</span>
          <%= if @opencode_server_status.running do %>
            <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
          <% else %>
            <span class="w-2 h-2 rounded-full bg-base-content/30"></span>
          <% end %>
        </div>
      <% end %>
      <div class="flex items-center space-x-1">
        <span class={"px-2 py-0.5 rounded text-[10px] " <> coding_agent_badge_class(@coding_agent_pref)}>
          <%= coding_agent_badge_text(@coding_agent_pref) %>
        </span>
      </div>
    </div>
  </div>

  <!-- Main Two-Column Layout -->
  <div class="flex-1 flex flex-col lg:flex-row gap-3 min-h-0">
    
    <!-- LEFT: Removed chat panel - use OpenClaw Control UI at https://balgownie.tail1b57dd.ts.net:8443/ -->

    <!-- Main Panels (full width, chat removed) -->
    <div class="w-full flex flex-col gap-3 overflow-y-auto">
      
      <!-- Compact Usage Stats -->
      <div class="glass-panel rounded-lg p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-[10px] font-mono text-accent uppercase tracking-wider">üìä Usage</span>
          <button phx-click="refresh_stats" class="text-[10px] text-base-content/40 hover:text-accent">‚Üª</button>
        </div>
        <div class="grid grid-cols-2 gap-3 text-xs font-mono">
          <div>
            <div class="text-base-content/50 mb-1">OpenCode</div>
            <div class="flex items-center space-x-2">
              <span class="text-white font-bold"><%= @usage_stats.opencode[:sessions] || 0 %></span>
              <span class="text-base-content/40">sess</span>
              <span class="text-success"><%= @usage_stats.opencode[:total_cost] || "$0" %></span>
            </div>
          </div>
          <div>
            <div class="text-base-content/50 mb-1">Claude</div>
            <div class="flex items-center space-x-2">
              <span class="text-white font-bold"><%= @usage_stats.claude[:sessions] || 0 %></span>
              <span class="text-base-content/40">sess</span>
              <span class="text-success"><%= @usage_stats.claude[:cost] || "$0" %></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Linear Tickets Panel (LiveComponent) -->
      <.live_component
        module={LinearComponent}
        id="linear-tickets"
        linear_tickets={@linear_tickets}
        linear_counts={@linear_counts}
        linear_loading={@linear_loading}
        linear_error={@linear_error}
        linear_collapsed={@linear_collapsed}
        linear_status_filter={@linear_status_filter}
        tickets_in_progress={@tickets_in_progress}
      />

      <!-- Chainlink Issues Panel (LiveComponent) -->
      <.live_component
        module={ChainlinkComponent}
        id="chainlink-issues"
        chainlink_issues={@chainlink_issues}
        chainlink_loading={@chainlink_loading}
        chainlink_error={@chainlink_error}
        chainlink_collapsed={@chainlink_collapsed}
        chainlink_work_in_progress={@chainlink_work_in_progress}
      />

      <!-- GitHub Pull Requests Panel -->
      <.live_component
        module={PRsComponent}
        id="prs-panel"
        github_prs={@github_prs}
        github_prs_loading={@github_prs_loading}
        github_prs_error={@github_prs_error}
        github_prs_last_updated={@github_prs_last_updated}
        prs_collapsed={@prs_collapsed}
        prs_in_progress={@prs_in_progress}
        pr_verifications={@pr_verifications}
        pr_fix_pending={@pr_fix_pending}
      />

      <!-- Unmerged Branches Panel -->
      <.live_component
        module={BranchesComponent}
        id="branches-panel"
        unmerged_branches={@unmerged_branches}
        branches_loading={@branches_loading}
        branches_error={@branches_error}
        branches_last_updated={@branches_last_updated}
        branches_collapsed={@branches_collapsed}
        branch_merge_pending={@branch_merge_pending}
        branch_delete_pending={@branch_delete_pending}
      />

      <!-- OpenCode Sessions Panel (LiveComponent) -->
      <.live_component
        module={OpenCodeComponent}
        id="opencode-panel"
        opencode_server_status={@opencode_server_status}
        opencode_sessions={@opencode_sessions}
        opencode_collapsed={@opencode_collapsed}
      />

      <!-- Gemini CLI Panel (LiveComponent) -->
      <.live_component
        module={GeminiComponent}
        id="gemini-panel"
        gemini_server_status={@gemini_server_status}
        gemini_output={@gemini_output}
        gemini_collapsed={@gemini_collapsed}
      />

      <!-- Dave Panel (Main Agent) -->
      <.live_component
        module={DaveComponent}
        id="dave-panel"
        agent_sessions={@agent_sessions}
        dave_collapsed={@dave_collapsed}
      />

      <!-- Sub-Agents Panel -->
      <.live_component
        module={SubagentsComponent}
        id="subagents-panel"
        agent_sessions={@agent_sessions}
        subagents_collapsed={@subagents_collapsed}
        dismissed_sessions={@dismissed_sessions}
        show_completed={@show_completed}
      />

      <!-- Live Progress Panel -->
      <div class="glass-panel rounded-lg overflow-hidden flex-1 min-h-[200px]">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="live_progress"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@live_progress_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-accent uppercase tracking-wider">üì° Live Feed</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= @agent_progress_count %></span>
          </div>
          <button phx-click="clear_progress" class="text-[10px] text-base-content/40 hover:text-accent" onclick="event.stopPropagation()">Clear</button>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@live_progress_collapsed, do: "max-h-0", else: "max-h-[400px] flex-1")}>
          <div class="px-3 pb-3 h-full max-h-[350px] overflow-y-auto font-mono text-[10px]" id="progress-feed" phx-hook="ScrollBottom" phx-update="stream">
            <%= for {id, event} <- @streams.progress_events do %>
              <div id={id} class="py-0.5 flex items-start space-x-1">
                <span class="text-base-content/40 w-12 flex-shrink-0"><%= format_time(event.ts) %></span>
                <span class={agent_color(event.agent) <> " w-20 flex-shrink-0 truncate"}><%= event.agent %></span>
                <span class={action_color(event.action) <> " font-bold w-10 flex-shrink-0"}><%= event.action %></span>
                <span class="text-base-content/70 truncate flex-1"><%= event.target %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Panels Row (Less Important - Collapsed by Default) -->
  <div class="mt-3 space-y-2">
    
    <!-- Config Panel (LiveComponent) -->
    <.live_component
      module={ConfigComponent}
      id="config-panel"
      config_collapsed={@config_collapsed}
      coding_agent_pref={@coding_agent_pref}
      claude_model={@claude_model}
      opencode_model={@opencode_model}
      opencode_server_status={@opencode_server_status}
      gemini_server_status={@gemini_server_status}
    />

    <!-- Coding Agents Panel -->
    <%= if @coding_agents != [] do %>
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="coding_agents"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@coding_agents_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-base-content/60 uppercase tracking-wider">üíª Coding Agents</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= @coding_agents_count %></span>
          </div>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@coding_agents_collapsed, do: "max-h-0", else: "max-h-[200px]")}>
          <div class="px-3 pb-3">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
              <%= for agent <- @coding_agents do %>
                <div class={"px-2 py-1.5 rounded text-xs font-mono " <> if(agent.status == "running", do: "bg-warning/10", else: "bg-white/5")}>
                  <div class="flex items-center justify-between">
                    <span class="text-white font-bold"><%= agent.type %></span>
                    <button phx-click="kill_process" phx-value-pid={agent.pid} class="text-error/50 hover:text-error">‚úï</button>
                  </div>
                  <div class="text-[10px] text-base-content/50 mt-1">
                    CPU: <%= agent.cpu %>% | MEM: <%= agent.memory %>%
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- System & Relationships Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-2">
      <!-- System Processes -->
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="system_processes"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@system_processes_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-base-content/60 uppercase tracking-wider">‚öôÔ∏è System</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= @recent_processes_count %></span>
          </div>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@system_processes_collapsed, do: "max-h-0", else: "max-h-[150px]")}>
          <div class="px-3 pb-3 grid grid-cols-2 gap-1">
            <%= for process <- Enum.take(@recent_processes, 4) do %>
              <div class="px-2 py-1 rounded bg-white/5 text-[10px] font-mono">
                <div class="text-white truncate"><%= process.name %></div>
                <div class="text-base-content/50">CPU: <%= Map.get(process, :cpu_usage, "?") %> | MEM: <%= Map.get(process, :memory_usage, "?") %></div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Process Relationships -->
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="process_relationships"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@process_relationships_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-base-content/60 uppercase tracking-wider">üîó Relationships</span>
          </div>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out " <> if(@process_relationships_collapsed, do: "max-h-0 overflow-hidden", else: "")}>
          <div class="p-2">
            <div id="relationship-graph" phx-hook="RelationshipGraph" phx-update="ignore" class="w-full h-[180px]"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Work on Ticket Modal -->
  <%= if @show_work_modal do %>
    <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" phx-click="close_work_modal">
      <div class="glass-panel rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto" phx-click-away="close_work_modal">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <span class="text-2xl">üé´</span>
            <h2 class="text-lg font-bold text-white font-mono"><%= @work_ticket_id %></h2>
          </div>
          <button phx-click="close_work_modal" class="text-base-content/60 hover:text-white text-xl">‚úï</button>
        </div>
        
        <!-- Ticket Details -->
        <div class="mb-6">
          <div class="text-xs font-mono text-accent uppercase tracking-wider mb-2">Ticket Details</div>
          <%= if @work_ticket_loading do %>
            <div class="flex items-center space-x-2 text-base-content/60">
              <span class="throbber"></span>
              <span class="text-sm">Fetching ticket details...</span>
            </div>
          <% else %>
            <pre class="text-xs font-mono text-base-content/80 bg-black/40 rounded-lg p-4 whitespace-pre-wrap overflow-x-auto max-h-64 overflow-y-auto"><%= @work_ticket_details %></pre>
          <% end %>
        </div>
        
        <!-- Execute Work -->
        <div class="border-t border-white/10 pt-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-xs font-mono text-accent uppercase tracking-wider">Start Working</div>
            <div class={"text-[10px] font-mono px-2 py-1 rounded " <> coding_agent_badge_class(@coding_agent_pref)}>
              Using: <%= coding_agent_badge_text(@coding_agent_pref) %>
            </div>
          </div>
          
          <%= if @work_error do %>
            <div class="bg-error/20 text-error rounded-lg p-3 text-sm font-mono mb-3"><%= @work_error %></div>
          <% end %>
          
          <div class="flex items-center space-x-3">
            <button
              phx-click="execute_work"
              disabled={@work_in_progress or @work_ticket_loading or @work_sent}
              class={"flex-1 py-3 rounded-lg text-sm font-mono font-bold transition-all " <> 
                cond do
                  @work_sent -> "bg-green-500/30 text-green-300"
                  @work_in_progress -> "bg-blue-500/30 text-blue-300 cursor-wait"
                  true -> "bg-accent/20 text-accent hover:bg-accent/40"
                end}
            >
              <%= cond do %>
                <% @work_sent -> %>‚úì Work Started
                <% @work_in_progress -> %><span class="inline-block animate-spin mr-2">‚ü≥</span> Starting...
                <% true -> %>üöÄ Execute Work
              <% end %>
            </button>
            <a 
              href={"https://linear.app/fresh-clinics/issue/#{@work_ticket_id}"} 
              target="_blank"
              class="px-4 py-3 rounded-lg bg-base-content/10 text-base-content/70 hover:bg-base-content/20 text-sm font-mono"
            >
              Linear ‚Üó
            </a>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
