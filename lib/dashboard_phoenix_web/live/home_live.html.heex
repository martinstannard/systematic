<div class="min-h-screen flex flex-col" id="panel-state-container" phx-hook="PanelState">
  <!-- Compact Header -->
  <div class="glass-panel rounded-lg px-4 py-2 flex items-center justify-between mb-3">
    <div class="flex items-center space-x-4">
      <h1 class="text-sm font-bold tracking-widest text-base-content">SYSTEMATIC</h1>
      <span class="text-[10px] text-base-content/60 font-mono">AGENT CONTROL</span>
      
      <!-- Theme Toggle -->
      <button
        id="theme-toggle"
        phx-hook="ThemeToggle"
        class="p-1.5 rounded-lg bg-base-content/10 hover:bg-base-content/20 transition-colors"
        title="Toggle light/dark mode"
      >
        <svg class="sun-icon w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg class="moon-icon w-4 h-4 text-indigo-400" style="display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>
    </div>
    
    <!-- Compact Stats -->
    <div class="flex items-center space-x-6 text-xs font-mono">
      <div class="flex items-center space-x-2">
        <span class="text-base-content/50">Agents:</span>
        <span class="text-success font-bold"><%= length(@agent_sessions) %></span>
      </div>
      <div class="flex items-center space-x-2">
        <span class="text-base-content/50">Events:</span>
        <span class="text-primary font-bold"><%= length(@agent_progress) %></span>
      </div>
      <%= if @coding_agent_pref == :opencode do %>
        <div class="flex items-center space-x-2">
          <span class="text-base-content/50">ACP:</span>
          <%= if @opencode_server_status.running do %>
            <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
          <% else %>
            <span class="w-2 h-2 rounded-full bg-base-content/30"></span>
          <% end %>
        </div>
      <% end %>
      <div class="flex items-center space-x-1">
        <span class={"px-2 py-0.5 rounded text-[10px] " <> coding_agent_badge_class(@coding_agent_pref)}>
          <%= coding_agent_badge_text(@coding_agent_pref) %>
        </span>
      </div>
    </div>
  </div>

  <!-- Main Two-Column Layout -->
  <div class="flex-1 flex flex-col lg:flex-row gap-3 min-h-0">
    
    <!-- LEFT: Removed chat panel - use OpenClaw Control UI at https://balgownie.tail1b57dd.ts.net:8443/ -->

    <!-- Main Panels (full width, chat removed) -->
    <div class="w-full flex flex-col gap-3 overflow-y-auto">
      
      <!-- Compact Usage Stats -->
      <div class="glass-panel rounded-lg p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-[10px] font-mono text-accent uppercase tracking-wider">üìä Usage</span>
          <button phx-click="refresh_stats" class="text-[10px] text-base-content/40 hover:text-accent">‚Üª</button>
        </div>
        <div class="grid grid-cols-2 gap-3 text-xs font-mono">
          <div>
            <div class="text-base-content/50 mb-1">OpenCode</div>
            <div class="flex items-center space-x-2">
              <span class="text-white font-bold"><%= @usage_stats.opencode[:sessions] || 0 %></span>
              <span class="text-base-content/40">sess</span>
              <span class="text-success"><%= @usage_stats.opencode[:total_cost] || "$0" %></span>
            </div>
          </div>
          <div>
            <div class="text-base-content/50 mb-1">Claude</div>
            <div class="flex items-center space-x-2">
              <span class="text-white font-bold"><%= @usage_stats.claude[:sessions] || 0 %></span>
              <span class="text-base-content/40">sess</span>
              <span class="text-success"><%= @usage_stats.claude[:cost] || "$0" %></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Linear Tickets Panel (LiveComponent) -->
      <.live_component
        module={LinearComponent}
        id="linear-tickets"
        linear_tickets={@linear_tickets}
        linear_counts={@linear_counts}
        linear_loading={@linear_loading}
        linear_error={@linear_error}
        linear_collapsed={@linear_collapsed}
        linear_status_filter={@linear_status_filter}
        tickets_in_progress={@tickets_in_progress}
      />

      <!-- Chainlink Issues Panel (LiveComponent) -->
      <.live_component
        module={ChainlinkComponent}
        id="chainlink-issues"
        chainlink_issues={@chainlink_issues}
        chainlink_loading={@chainlink_loading}
        chainlink_error={@chainlink_error}
        chainlink_collapsed={@chainlink_collapsed}
        chainlink_work_in_progress={@chainlink_work_in_progress}
      />

      <!-- GitHub Pull Requests Panel -->
      <.live_component
        module={PRsComponent}
        id="prs-panel"
        github_prs={@github_prs}
        github_prs_loading={@github_prs_loading}
        github_prs_error={@github_prs_error}
        github_prs_last_updated={@github_prs_last_updated}
        prs_collapsed={@prs_collapsed}
        prs_in_progress={@prs_in_progress}
        pr_verifications={@pr_verifications}
        pr_fix_pending={@pr_fix_pending}
      />

      <!-- Unmerged Branches Panel -->
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="branches"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@branches_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-accent uppercase tracking-wider">üåø Unmerged Branches</span>
            <%= if @branches_loading do %>
              <span class="throbber-small"></span>
            <% else %>
              <span class="text-[10px] font-mono text-base-content/50"><%= length(@unmerged_branches) %></span>
            <% end %>
          </div>
          <button phx-click="refresh_branches" class="text-[10px] text-base-content/40 hover:text-accent" onclick="event.stopPropagation()">‚Üª</button>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@branches_collapsed, do: "max-h-0", else: "max-h-[400px]")}>
          <div class="px-3 pb-3">
            <!-- Branch List -->
            <div class="space-y-2 max-h-[350px] overflow-y-auto">
              <%= if @branches_loading do %>
                <div class="flex items-center justify-center py-4 space-x-2">
                  <span class="throbber-small"></span>
                  <span class="text-xs text-base-content/50 font-mono">Loading branches...</span>
                </div>
              <% else %>
                <%= if @branches_error do %>
                  <div class="text-xs text-error/70 py-2 px-2"><%= @branches_error %></div>
                <% end %>
                <%= if @unmerged_branches == [] do %>
                  <div class="text-xs text-base-content/50 py-4 text-center font-mono">No unmerged branches</div>
                <% end %>
                <%= for branch <- @unmerged_branches do %>
                  <div class="px-2 py-2 rounded hover:bg-white/5 text-xs font-mono border border-white/5">
                    <!-- Branch Name and Actions -->
                    <div class="flex items-start justify-between mb-1">
                      <div class="flex items-center space-x-2 min-w-0">
                        <%= if branch.has_worktree do %>
                          <span class="text-green-400" title={"Worktree: #{branch.worktree_path}"}>üå≤</span>
                        <% else %>
                          <span class="text-base-content/30">üîÄ</span>
                        <% end %>
                        <span class="text-white truncate" title={branch.name}><%= branch.name %></span>
                        <span class="px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400 text-[10px]">
                          +<%= branch.commits_ahead %>
                        </span>
                      </div>
                      
                      <!-- Action Buttons -->
                      <div class="flex items-center space-x-1 ml-2">
                        <%= if @branch_merge_pending == branch.name do %>
                          <!-- Merge Confirmation -->
                          <span class="text-[10px] text-warning mr-1">Merge?</span>
                          <button
                            phx-click="execute_merge_branch"
                            phx-value-name={branch.name}
                            class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-400 hover:bg-green-500/40 text-[10px]"
                          >
                            ‚úì
                          </button>
                          <button
                            phx-click="cancel_merge_branch"
                            class="px-1.5 py-0.5 rounded bg-base-content/10 text-base-content/60 hover:bg-base-content/20 text-[10px]"
                          >
                            ‚úó
                          </button>
                        <% else %>
                          <%= if @branch_delete_pending == branch.name do %>
                            <!-- Delete Confirmation -->
                            <span class="text-[10px] text-error mr-1">Delete?</span>
                            <button
                              phx-click="execute_delete_branch"
                              phx-value-name={branch.name}
                              class="px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 hover:bg-red-500/40 text-[10px]"
                            >
                              ‚úì
                            </button>
                            <button
                              phx-click="cancel_delete_branch"
                              class="px-1.5 py-0.5 rounded bg-base-content/10 text-base-content/60 hover:bg-base-content/20 text-[10px]"
                            >
                              ‚úó
                            </button>
                          <% else %>
                            <!-- Normal Buttons -->
                            <button
                              phx-click="confirm_merge_branch"
                              phx-value-name={branch.name}
                              class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-400 hover:bg-green-500/40 text-[10px]"
                              title="Merge to main"
                            >
                              ‚§µ Merge
                            </button>
                            <button
                              phx-click="confirm_delete_branch"
                              phx-value-name={branch.name}
                              class="px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 hover:bg-red-500/40 text-[10px]"
                              title="Delete branch"
                            >
                              üóë
                            </button>
                          <% end %>
                        <% end %>
                      </div>
                    </div>
                    
                    <!-- Last Commit Info -->
                    <div class="flex items-center space-x-2 text-[10px] text-base-content/50">
                      <%= if branch.last_commit_message do %>
                        <span class="truncate flex-1" title={branch.last_commit_message}><%= branch.last_commit_message %></span>
                        <span>‚Ä¢</span>
                      <% end %>
                      <%= if branch.last_commit_author do %>
                        <span class="text-base-content/40"><%= branch.last_commit_author %></span>
                        <span>‚Ä¢</span>
                      <% end %>
                      <%= if branch.last_commit_date do %>
                        <span><%= format_branch_time(branch.last_commit_date) %></span>
                      <% end %>
                    </div>
                    
                    <!-- Worktree Path if applicable -->
                    <%= if branch.has_worktree do %>
                      <div class="text-[10px] text-green-400/60 mt-1 truncate" title={branch.worktree_path}>
                        üìÅ <%= branch.worktree_path %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              <% end %>
            </div>
            
            <!-- Last Updated -->
            <%= if @branches_last_updated do %>
              <div class="text-[9px] text-base-content/30 mt-2 text-right font-mono">
                Updated <%= format_branch_time(@branches_last_updated) %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- OpenCode Sessions Panel -->
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="opencode"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@opencode_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-accent uppercase tracking-wider">üíª OpenCode</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= length(@opencode_sessions) %></span>
          </div>
          <button phx-click="refresh_opencode_sessions" class="text-[10px] text-base-content/40 hover:text-accent" onclick="event.stopPropagation()">‚Üª</button>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@opencode_collapsed, do: "max-h-0", else: "max-h-[300px]")}>
          <div class="px-3 pb-3 space-y-1 max-h-[250px] overflow-y-auto">
            <%= if not @opencode_server_status.running do %>
              <div class="text-center py-2">
                <div class="text-[10px] text-base-content/40 mb-1">Server not running</div>
                <button phx-click="start_opencode_server" class="text-[10px] px-2 py-1 rounded bg-success/20 text-success hover:bg-success/40">
                  Start
                </button>
              </div>
            <% else %>
              <%= for session <- @opencode_sessions do %>
                <div class="flex items-center space-x-2 px-2 py-1.5 rounded hover:bg-white/5 text-xs font-mono">
                  <span class={opencode_status_badge(session.status)}><%= session.status %></span>
                  <span class="text-white truncate flex-1" title={session.title}><%= session.slug %></span>
                  <%= if session.file_changes.files > 0 do %>
                    <span class="text-green-400 text-[10px]">+<%= session.file_changes.additions %></span>
                    <span class="text-red-400 text-[10px]">-<%= session.file_changes.deletions %></span>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Gemini CLI Panel -->
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="gemini"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@gemini_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-accent uppercase tracking-wider">‚ú® Gemini CLI</span>
            <%= if @gemini_server_status.running do %>
              <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
            <% end %>
          </div>
          <%= if @gemini_server_status.running do %>
            <button phx-click="clear_gemini_output" class="text-[10px] text-base-content/40 hover:text-accent" onclick="event.stopPropagation()">Clear</button>
          <% end %>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@gemini_collapsed, do: "max-h-0", else: "max-h-[400px]")}>
          <div class="px-3 pb-3">
            <%= if not @gemini_server_status.running do %>
              <div class="text-center py-4">
                <div class="text-[10px] text-base-content/40 mb-2">Gemini CLI not running</div>
                <button phx-click="start_gemini_server" class="text-xs px-3 py-1.5 rounded bg-green-500/20 text-green-400 hover:bg-green-500/40">
                  ‚ú® Start Gemini
                </button>
              </div>
            <% else %>
              <!-- Status -->
              <div class="flex items-center justify-between mb-2 text-[10px] font-mono">
                <div class="flex items-center space-x-2">
                  <span class="text-base-content/50">Status:</span>
                  <%= if @gemini_server_status[:busy] do %>
                    <span class="text-warning animate-pulse">Running...</span>
                  <% else %>
                    <span class="text-green-400">Ready</span>
                  <% end %>
                  <span class="text-base-content/30">|</span>
                  <span class="text-base-content/50">Dir:</span>
                  <span class="text-blue-400 truncate max-w-[150px]" title={@gemini_server_status.cwd}><%= @gemini_server_status.cwd %></span>
                </div>
                <button phx-click="stop_gemini_server" class="px-2 py-0.5 rounded bg-error/20 text-error hover:bg-error/40 text-[10px]">
                  Stop
                </button>
              </div>
              
              <!-- Output -->
              <div class="bg-black/40 rounded-lg p-2 mb-2 max-h-[200px] overflow-y-auto font-mono text-[10px] text-base-content/70" id="gemini-output" phx-hook="ScrollBottom">
                <%= if @gemini_output == "" do %>
                  <span class="text-base-content/40 italic">Waiting for output...</span>
                <% else %>
                  <pre class="whitespace-pre-wrap"><%= @gemini_output %></pre>
                <% end %>
              </div>
              
              <!-- Prompt Input -->
              <form phx-submit="send_gemini_prompt" class="flex items-center space-x-2">
                <input
                  type="text"
                  name="prompt"
                  placeholder="Send a prompt to Gemini..."
                  class="flex-1 bg-black/30 border border-white/10 rounded px-3 py-1.5 text-xs font-mono text-white placeholder-base-content/40 focus:outline-none focus:border-green-500/50"
                  autocomplete="off"
                />
                <button
                  type="submit"
                  class="px-3 py-1.5 rounded bg-green-500/20 text-green-400 hover:bg-green-500/40 text-xs font-mono"
                >
                  Send
                </button>
              </form>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Dave Panel (Main Agent) -->
      <% main_agent_session = Enum.find(@agent_sessions, fn s -> Map.get(s, :session_key) == "agent:main:main" end) %>
      <%= if main_agent_session do %>
        <div class="glass-panel rounded-lg overflow-hidden border-2 border-purple-500/30" id="dave">
          <div 
            class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-purple-500/10 transition-colors bg-purple-500/5"
            phx-click="toggle_panel"
            phx-value-panel="dave"
          >
            <div class="flex items-center space-x-2">
              <span class={"text-xs transition-transform duration-200 " <> if(@dave_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
              <span class="text-xs font-mono text-purple-400 uppercase tracking-wider">üêô Dave</span>
              <span class={"px-1.5 py-0.5 rounded text-[10px] " <> status_badge(main_agent_session.status)}>
                <%= main_agent_session.status %>
              </span>
            </div>
            <div class="flex items-center space-x-2">
              <% {_type, model_name, model_icon} = agent_type_from_model(Map.get(main_agent_session, :model)) %>
              <span class="px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-400 text-[10px]" title={Map.get(main_agent_session, :model)}>
                <%= model_icon %> <%= model_name %>
              </span>
            </div>
          </div>
          
          <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@dave_collapsed, do: "max-h-0", else: "max-h-[400px]")}>
            <div class="px-3 pb-3">
              <% current_action = Map.get(main_agent_session, :current_action) %>
              <% recent_actions = Map.get(main_agent_session, :recent_actions, []) %>
              
              <!-- Current Activity -->
              <div class="py-2">
                <%= if main_agent_session.status == "running" do %>
                  <%= if current_action do %>
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="throbber-small"></span>
                      <span class="text-[10px] text-purple-400/70">Current:</span>
                      <span class="text-purple-300 text-xs font-mono truncate animate-pulse" title={current_action}>
                        <%= current_action %>
                      </span>
                    </div>
                  <% else %>
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="throbber-small"></span>
                      <span class="text-xs text-purple-400/60 italic">Working...</span>
                    </div>
                  <% end %>
                <% else %>
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="text-purple-400">‚óã</span>
                    <span class="text-xs text-purple-400/60">Idle</span>
                  </div>
                <% end %>
                
                <!-- Recent Actions -->
                <%= if recent_actions != [] do %>
                  <div class="text-[10px] text-base-content/40 space-y-0.5 max-h-[100px] overflow-y-auto">
                    <%= for action <- Enum.take(recent_actions, -5) do %>
                      <div class="truncate" title={action}>‚úì <%= action %></div>
                    <% end %>
                  </div>
                <% end %>
              </div>
              
              <!-- Stats Footer -->
              <div class="pt-2 border-t border-purple-500/20 flex items-center justify-between text-[10px] font-mono">
                <div class="flex items-center space-x-3 text-base-content/50">
                  <span>‚Üì <%= format_tokens(Map.get(main_agent_session, :tokens_in, 0)) %></span>
                  <span>‚Üë <%= format_tokens(Map.get(main_agent_session, :tokens_out, 0)) %></span>
                </div>
                <%= if Map.get(main_agent_session, :cost, 0) > 0 do %>
                  <span class="text-success/60">$<%= Float.round(main_agent_session.cost, 4) %></span>
                <% end %>
                <%= if Map.get(main_agent_session, :runtime) do %>
                  <span class="text-purple-400/60"><%= main_agent_session.runtime %></span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Sub-Agents Panel (Enhanced) -->
      <% sub_agent_sessions = Enum.reject(@agent_sessions, fn s -> Map.get(s, :session_key) == "agent:main:main" end) %>
      <div class="glass-panel rounded-lg overflow-hidden" id="subagents">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="subagents"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@subagents_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-accent uppercase tracking-wider">ü§ñ Sub-Agents</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= length(sub_agent_sessions) %></span>
            <% running_count = Enum.count(sub_agent_sessions, fn s -> s.status == "running" end) %>
            <%= if running_count > 0 do %>
              <span class="px-1.5 py-0.5 rounded bg-warning/20 text-warning text-[10px] animate-pulse">
                <%= running_count %> active
              </span>
            <% end %>
          </div>
          <% completed_count = Enum.count(sub_agent_sessions, fn s -> s.status == "completed" && !MapSet.member?(@dismissed_sessions, s.id) end) %>
          <%= if completed_count > 0 do %>
            <button phx-click="clear_completed" class="text-[10px] px-2 py-0.5 rounded bg-base-content/10 text-base-content/50 hover:bg-accent/20 hover:text-accent transition-colors uppercase tracking-wider" onclick="event.stopPropagation()">
              Clear Completed (<%= completed_count %>)
            </button>
          <% end %>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@subagents_collapsed, do: "max-h-0", else: "max-h-[500px]")}>
          <div class="px-3 pb-3 space-y-2 max-h-[450px] overflow-y-auto">
            <% visible_sessions = sub_agent_sessions
              |> Enum.reject(fn s -> MapSet.member?(@dismissed_sessions, s.id) end)
              |> Enum.reject(fn s -> !@show_completed && s.status == "completed" end) %>
            <%= if visible_sessions == [] do %>
              <div class="text-xs text-base-content/40 py-4 text-center font-mono">No active sub-agents</div>
            <% end %>
            <%= for session <- visible_sessions do %>
              <% status = Map.get(session, :status, "unknown") %>
              <% {agent_type, agent_name, agent_icon} = agent_type_from_model(Map.get(session, :model)) %>
              <% task = Map.get(session, :task_summary) %>
              <% current_action = Map.get(session, :current_action) %>
              <% recent_actions = Map.get(session, :recent_actions, []) %>
              <% start_time = session_start_timestamp(session) %>
              
              <div class={"rounded-lg border text-xs font-mono " <> 
                if(status == "running", 
                  do: "bg-warning/5 border-warning/30", 
                  else: if(status == "completed", do: "bg-success/5 border-success/20", else: "bg-white/5 border-white/10"))}>
                
                <!-- Header Row: Status, Label, Agent Type, Duration -->
                <div class="flex flex-wrap items-start justify-between gap-2 px-3 py-2 border-b border-white/5">
                  <div class="flex items-start space-x-2 min-w-0 flex-1">
                    <%= if status == "running" do %>
                      <span class="throbber-small flex-shrink-0 mt-0.5"></span>
                    <% else %>
                      <span class={"flex-shrink-0 mt-0.5 " <> if(status == "completed", do: "text-success", else: "text-info")}>
                        <%= if status == "completed", do: "‚úì", else: "‚óã" %>
                      </span>
                    <% end %>
                    <span class="text-white font-medium break-words" title={Map.get(session, :label) || Map.get(session, :id)}>
                      <%= Map.get(session, :label) || String.slice(Map.get(session, :id, ""), 0, 8) %>
                    </span>
                  </div>
                  
                  <div class="flex items-center space-x-2 flex-shrink-0">
                    <!-- Agent Type Badge -->
                    <span class={"px-1.5 py-0.5 rounded text-[10px] " <> agent_type_badge_class(agent_type)} title={Map.get(session, :model)}>
                      <%= agent_icon %> <%= agent_name %>
                    </span>
                    
                    <!-- Live Duration (for running) or Static (for completed) -->
                    <%= if status == "running" do %>
                      <span 
                        class="px-1.5 py-0.5 rounded bg-warning/20 text-warning text-[10px] tabular-nums"
                        id={"duration-#{session.id}"}
                        phx-hook="LiveDuration"
                        data-start-time={start_time}
                      >
                        <%= Map.get(session, :runtime) || "..." %>
                      </span>
                    <% else %>
                      <%= if Map.get(session, :runtime) do %>
                        <span class="px-1.5 py-0.5 rounded bg-base-content/10 text-base-content/60 text-[10px] tabular-nums">
                          <%= session.runtime %>
                        </span>
                      <% end %>
                    <% end %>
                    
                    <!-- Status Badge -->
                    <span class={status_badge(status)}><%= status %></span>
                  </div>
                </div>
                
                <!-- Task Description -->
                <%= if task do %>
                  <div class="px-3 py-2 border-b border-white/5">
                    <div class="text-[10px] text-base-content/50 mb-0.5">Task</div>
                    <div class="text-base-content/80 text-[11px] leading-relaxed" title={task}>
                      <%= task %>
                    </div>
                  </div>
                <% end %>
                
                <!-- Live Work Status (for running agents) -->
                <%= if status == "running" do %>
                  <div class="px-3 py-2">
                    <%= if current_action do %>
                      <div class="flex items-center space-x-2 mb-1">
                        <span class="text-[10px] text-warning/70">‚ñ∂ Now:</span>
                        <span class="text-warning text-[11px] truncate animate-pulse" title={current_action}>
                          <%= current_action %>
                        </span>
                      </div>
                    <% end %>
                    
                    <%= if recent_actions != [] do %>
                      <div class="text-[10px] text-base-content/40 space-y-0.5">
                        <%= for action <- Enum.take(recent_actions, -3) do %>
                          <div class="truncate" title={action}>‚úì <%= action %></div>
                        <% end %>
                      </div>
                    <% end %>
                    
                    <%= if current_action == nil && recent_actions == [] do %>
                      <div class="text-[10px] text-base-content/40 italic">Initializing...</div>
                    <% end %>
                  </div>
                <% end %>
                
                <!-- Result snippet for completed agents -->
                <%= if status == "completed" && Map.get(session, :result_snippet) do %>
                  <div class="px-3 py-2">
                    <div class="text-[10px] text-success/70 mb-0.5">Result</div>
                    <div class="text-base-content/70 text-[11px] truncate" title={session.result_snippet}>
                      <%= session.result_snippet %>
                    </div>
                  </div>
                <% end %>
                
                <!-- Footer: Tokens & Cost (if available) -->
                <%= if (Map.get(session, :tokens_in, 0) > 0 || Map.get(session, :tokens_out, 0) > 0) do %>
                  <div class="px-3 py-1.5 bg-black/20 flex items-center justify-between text-[10px] text-base-content/40">
                    <div class="flex items-center space-x-3">
                      <span>‚Üì <%= format_tokens(session.tokens_in) %></span>
                      <span>‚Üë <%= format_tokens(session.tokens_out) %></span>
                    </div>
                    <%= if Map.get(session, :cost, 0) > 0 do %>
                      <span class="text-success/60">$<%= Float.round(session.cost, 4) %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Live Progress Panel -->
      <div class="glass-panel rounded-lg overflow-hidden flex-1 min-h-[200px]">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="live_progress"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@live_progress_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-accent uppercase tracking-wider">üì° Live Feed</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= length(@agent_progress) %></span>
          </div>
          <button phx-click="clear_progress" class="text-[10px] text-base-content/40 hover:text-accent" onclick="event.stopPropagation()">Clear</button>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@live_progress_collapsed, do: "max-h-0", else: "max-h-[400px] flex-1")}>
          <div class="px-3 pb-3 h-full max-h-[350px] overflow-y-auto font-mono text-[10px]" id="progress-feed" phx-hook="ScrollBottom">
            <%= for event <- Enum.take(@agent_progress, -50) do %>
              <div class="py-0.5 flex items-start space-x-1">
                <span class="text-base-content/40 w-12 flex-shrink-0"><%= format_time(event.ts) %></span>
                <span class={agent_color(event.agent) <> " w-20 flex-shrink-0 truncate"}><%= event.agent %></span>
                <span class={action_color(event.action) <> " font-bold w-10 flex-shrink-0"}><%= event.action %></span>
                <span class="text-base-content/70 truncate flex-1"><%= event.target %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Panels Row (Less Important - Collapsed by Default) -->
  <div class="mt-3 space-y-2">
    
    <!-- Config Panel (Compact) -->
    <div class="glass-panel rounded-lg overflow-hidden">
      <div 
        class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
        phx-click="toggle_panel"
        phx-value-panel="config"
      >
        <div class="flex items-center space-x-2">
          <span class={"text-xs transition-transform duration-200 " <> if(@config_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
          <span class="text-xs font-mono text-base-content/60 uppercase tracking-wider">‚öôÔ∏è Config</span>
        </div>
        <div class="flex items-center space-x-2 text-[10px] font-mono text-base-content/40">
          <span><%= if @coding_agent_pref == :opencode, do: "OpenCode + #{@opencode_model}", else: "Claude + #{String.replace(@claude_model, "anthropic/claude-", "")}" %></span>
        </div>
      </div>
      
      <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@config_collapsed, do: "max-h-0", else: "max-h-[400px]")}>
        <div class="px-4 py-3 border-t border-white/5">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Coding Agent Toggle (3-way) -->
            <div>
              <div class="text-[10px] font-mono text-base-content/50 mb-2">Coding Agent</div>
              <div class="flex rounded-lg overflow-hidden border border-white/10">
                <button 
                  phx-click="set_coding_agent"
                  phx-value-agent="opencode"
                  class={"flex-1 flex items-center justify-center space-x-1 px-2 py-2 text-xs font-mono transition-all " <> 
                    if(@coding_agent_pref == :opencode, 
                      do: "bg-blue-500/30 text-blue-400",
                      else: "bg-base-content/5 text-base-content/50 hover:bg-base-content/10"
                    )}
                >
                  <span>üíª</span>
                  <span class="hidden sm:inline">OpenCode</span>
                </button>
                <button 
                  phx-click="set_coding_agent"
                  phx-value-agent="claude"
                  class={"flex-1 flex items-center justify-center space-x-1 px-2 py-2 text-xs font-mono transition-all border-x border-white/10 " <> 
                    if(@coding_agent_pref == :claude, 
                      do: "bg-purple-500/30 text-purple-400",
                      else: "bg-base-content/5 text-base-content/50 hover:bg-base-content/10"
                    )}
                >
                  <span>ü§ñ</span>
                  <span class="hidden sm:inline">Claude</span>
                </button>
                <button 
                  phx-click="set_coding_agent"
                  phx-value-agent="gemini"
                  class={"flex-1 flex items-center justify-center space-x-1 px-2 py-2 text-xs font-mono transition-all " <> 
                    if(@coding_agent_pref == :gemini, 
                      do: "bg-green-500/30 text-green-400",
                      else: "bg-base-content/5 text-base-content/50 hover:bg-base-content/10"
                    )}
                >
                  <span>‚ú®</span>
                  <span class="hidden sm:inline">Gemini</span>
                </button>
              </div>
            </div>
            
            <!-- Claude Model -->
            <div>
              <div class="text-[10px] font-mono text-base-content/50 mb-2">Claude Model</div>
              <select 
                phx-change="select_claude_model"
                name="model"
                class="w-full text-sm font-mono bg-purple-500/10 border border-purple-500/30 rounded-lg px-3 py-2 text-purple-400"
              >
                <option value="anthropic/claude-opus-4-5" selected={@claude_model == "anthropic/claude-opus-4-5"}>Opus</option>
                <option value="anthropic/claude-sonnet-4-20250514" selected={@claude_model == "anthropic/claude-sonnet-4-20250514"}>Sonnet</option>
              </select>
            </div>
            
            <!-- OpenCode Model -->
            <div>
              <div class="text-[10px] font-mono text-base-content/50 mb-2">OpenCode Model</div>
              <select 
                phx-change="select_opencode_model"
                name="model"
                class="w-full text-sm font-mono bg-blue-500/10 border border-blue-500/30 rounded-lg px-3 py-2 text-blue-400"
              >
                <option value="gemini-3-pro" selected={@opencode_model == "gemini-3-pro"}>Gemini 3 Pro</option>
                <option value="gemini-3-flash" selected={@opencode_model == "gemini-3-flash"}>Gemini 3 Flash</option>
                <option value="gemini-2.5-pro" selected={@opencode_model == "gemini-2.5-pro"}>Gemini 2.5 Pro</option>
              </select>
            </div>
          </div>
          
          <!-- Server Controls based on selected agent -->
          <div class="mt-3 pt-3 border-t border-white/5">
            <%= cond do %>
              <% @coding_agent_pref == :opencode -> %>
                <!-- OpenCode Server Controls -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2 text-xs font-mono">
                    <span class="text-base-content/50">ACP Server:</span>
                    <%= if @opencode_server_status.running do %>
                      <span class="text-success">Running on :<%= @opencode_server_status.port %></span>
                    <% else %>
                      <span class="text-base-content/40">Stopped</span>
                    <% end %>
                  </div>
                  <%= if @opencode_server_status.running do %>
                    <button phx-click="stop_opencode_server" class="text-xs px-2 py-1 rounded bg-error/20 text-error hover:bg-error/40">Stop</button>
                  <% else %>
                    <button phx-click="start_opencode_server" class="text-xs px-2 py-1 rounded bg-success/20 text-success hover:bg-success/40">Start</button>
                  <% end %>
                </div>
              <% @coding_agent_pref == :gemini -> %>
                <!-- Gemini CLI Controls -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2 text-xs font-mono">
                    <span class="text-base-content/50">Gemini CLI:</span>
                    <%= if @gemini_server_status.running do %>
                      <%= if @gemini_server_status[:busy] do %>
                        <span class="text-warning animate-pulse">Running prompt...</span>
                      <% else %>
                        <span class="text-success">Ready</span>
                      <% end %>
                    <% else %>
                      <span class="text-base-content/40">Stopped</span>
                    <% end %>
                  </div>
                  <%= if @gemini_server_status.running do %>
                    <button phx-click="stop_gemini_server" class="text-xs px-2 py-1 rounded bg-error/20 text-error hover:bg-error/40">Stop</button>
                  <% else %>
                    <button phx-click="start_gemini_server" class="text-xs px-2 py-1 rounded bg-success/20 text-success hover:bg-success/40">Start</button>
                  <% end %>
                </div>
              <% true -> %>
                <!-- Claude sub-agents don't need server controls -->
                <div class="text-xs font-mono text-base-content/40">
                  Claude uses OpenClaw sub-agents (no server needed)
                </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Coding Agents Panel -->
    <%= if @coding_agents != [] do %>
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="coding_agents"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@coding_agents_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-base-content/60 uppercase tracking-wider">üíª Coding Agents</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= length(@coding_agents) %></span>
          </div>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@coding_agents_collapsed, do: "max-h-0", else: "max-h-[200px]")}>
          <div class="px-3 pb-3">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
              <%= for agent <- @coding_agents do %>
                <div class={"px-2 py-1.5 rounded text-xs font-mono " <> if(agent.status == "running", do: "bg-warning/10", else: "bg-white/5")}>
                  <div class="flex items-center justify-between">
                    <span class="text-white font-bold"><%= agent.type %></span>
                    <button phx-click="kill_process" phx-value-pid={agent.pid} class="text-error/50 hover:text-error">‚úï</button>
                  </div>
                  <div class="text-[10px] text-base-content/50 mt-1">
                    CPU: <%= agent.cpu %>% | MEM: <%= agent.memory %>%
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- System & Relationships Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-2">
      <!-- System Processes -->
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="system_processes"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@system_processes_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-base-content/60 uppercase tracking-wider">‚öôÔ∏è System</span>
            <span class="text-[10px] font-mono text-base-content/50"><%= length(@recent_processes) %></span>
          </div>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out overflow-hidden " <> if(@system_processes_collapsed, do: "max-h-0", else: "max-h-[150px]")}>
          <div class="px-3 pb-3 grid grid-cols-2 gap-1">
            <%= for process <- Enum.take(@recent_processes, 4) do %>
              <div class="px-2 py-1 rounded bg-white/5 text-[10px] font-mono">
                <div class="text-white truncate"><%= process.name %></div>
                <div class="text-base-content/50">CPU: <%= Map.get(process, :cpu_usage, "?") %> | MEM: <%= Map.get(process, :memory_usage, "?") %></div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Process Relationships -->
      <div class="glass-panel rounded-lg overflow-hidden">
        <div 
          class="flex items-center justify-between px-3 py-2 cursor-pointer select-none hover:bg-white/5 transition-colors"
          phx-click="toggle_panel"
          phx-value-panel="process_relationships"
        >
          <div class="flex items-center space-x-2">
            <span class={"text-xs transition-transform duration-200 " <> if(@process_relationships_collapsed, do: "-rotate-90", else: "rotate-0")}>‚ñº</span>
            <span class="text-xs font-mono text-base-content/60 uppercase tracking-wider">üîó Relationships</span>
          </div>
        </div>
        
        <div class={"transition-all duration-300 ease-in-out " <> if(@process_relationships_collapsed, do: "max-h-0 overflow-hidden", else: "")}>
          <div class="p-2">
            <div id="relationship-graph" phx-hook="RelationshipGraph" phx-update="ignore" class="w-full h-[180px]"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Work on Ticket Modal -->
  <%= if @show_work_modal do %>
    <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" phx-click="close_work_modal">
      <div class="glass-panel rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto" phx-click-away="close_work_modal">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <span class="text-2xl">üé´</span>
            <h2 class="text-lg font-bold text-white font-mono"><%= @work_ticket_id %></h2>
          </div>
          <button phx-click="close_work_modal" class="text-base-content/60 hover:text-white text-xl">‚úï</button>
        </div>
        
        <!-- Ticket Details -->
        <div class="mb-6">
          <div class="text-xs font-mono text-accent uppercase tracking-wider mb-2">Ticket Details</div>
          <%= if @work_ticket_loading do %>
            <div class="flex items-center space-x-2 text-base-content/60">
              <span class="throbber"></span>
              <span class="text-sm">Fetching ticket details...</span>
            </div>
          <% else %>
            <pre class="text-xs font-mono text-base-content/80 bg-black/40 rounded-lg p-4 whitespace-pre-wrap overflow-x-auto max-h-64 overflow-y-auto"><%= @work_ticket_details %></pre>
          <% end %>
        </div>
        
        <!-- Execute Work -->
        <div class="border-t border-white/10 pt-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-xs font-mono text-accent uppercase tracking-wider">Start Working</div>
            <div class={"text-[10px] font-mono px-2 py-1 rounded " <> coding_agent_badge_class(@coding_agent_pref)}>
              Using: <%= coding_agent_badge_text(@coding_agent_pref) %>
            </div>
          </div>
          
          <%= if @work_error do %>
            <div class="bg-error/20 text-error rounded-lg p-3 text-sm font-mono mb-3"><%= @work_error %></div>
          <% end %>
          
          <div class="flex items-center space-x-3">
            <button
              phx-click="execute_work"
              disabled={@work_in_progress or @work_ticket_loading or @work_sent}
              class={"flex-1 py-3 rounded-lg text-sm font-mono font-bold transition-all " <> 
                cond do
                  @work_sent -> "bg-green-500/30 text-green-300"
                  @work_in_progress -> "bg-blue-500/30 text-blue-300 cursor-wait"
                  true -> "bg-accent/20 text-accent hover:bg-accent/40"
                end}
            >
              <%= cond do %>
                <% @work_sent -> %>‚úì Work Started
                <% @work_in_progress -> %><span class="inline-block animate-spin mr-2">‚ü≥</span> Starting...
                <% true -> %>üöÄ Execute Work
              <% end %>
            </button>
            <a 
              href={"https://linear.app/fresh-clinics/issue/#{@work_ticket_id}"} 
              target="_blank"
              class="px-4 py-3 rounded-lg bg-base-content/10 text-base-content/70 hover:bg-base-content/20 text-sm font-mono"
            >
              Linear ‚Üó
            </a>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
