<div class="min-h-screen flex flex-col" id="panel-state-container" phx-hook="PanelState">
  <!-- Header Component -->
  <.live_component
    module={HeaderComponent}
    id="header"
    agent_sessions_count={@agent_sessions_count}
    agent_progress_count={@agent_progress_count}
    coding_agent_pref={@coding_agent_pref}
    opencode_server_status={@opencode_server_status}
    health_status={@health_status}
    health_last_check={@health_last_check}
  />
  
<!-- Main Dashboard Layout - Tabbed Interface (Ticket #127) -->
  <div
    class="flex-1 flex flex-col overflow-y-auto px-4 sm:px-8 py-4"
    role="region"
    aria-label="Dashboard panels"
  >
    <.live_component
      module={TabsComponent}
      id="main-tabs"
      active_tab={@active_tab}
      tabs={[
        %{
          id: "overview",
          label: "Overview",
          badge: @agent_progress_count,
          urgent: @agent_progress_count > 0
        },
        %{
          id: "work",
          label: "Work Items",
          badge: length(@linear_tickets) + @chainlink_issues_count,
          urgent: length(@linear_tickets) > 0 || @chainlink_issues_count > 0
        },
        %{
          id: "prs",
          label: "PRs & Branches",
          badge: @github_prs_count + @unmerged_branches_count,
          attention: @github_prs_count > 0
        },
        %{
          id: "agents",
          label: "Agents",
          badge: @agent_sessions_count,
          status: agent_status(@opencode_server_status, @gemini_server_status)
        },
        %{id: "system", label: "System", badge: @coding_agents_count}
      ]}
    >
      <%!-- Overview Tab (Work Panel, Activity) --%>
      <:tab_content tab="overview">
        <div class="flex flex-col gap-6">
          <!-- Work Panel -->
          <.live_component
            module={WorkPanelComponent}
            id="work-panel"
            agent_sessions={@agent_sessions}
            opencode_sessions={@opencode_sessions}
            gemini_server_status={@gemini_server_status}
            gemini_output={@gemini_output}
            work_panel_collapsed={@work_panel_collapsed}
            show_completed={@show_completed}
            dismissed_sessions={@dismissed_sessions}
            chainlink_work_in_progress={@chainlink_work_in_progress}
            work_registry_counts={@work_registry_counts}
            work_registry_entries={@work_registry_entries}
            sessions_loading={@sessions_loading}
            opencode_loading={@opencode_loading}
            gemini_loading={@gemini_loading}
          />
          
<!-- Unified Activity Panel -->
          <.live_component
            module={UnifiedActivityComponent}
            id="unified-activity"
            activity_events={@activity_events}
            progress_events={@streams.progress_events}
            agent_progress_count={@agent_progress_count}
            collapsed={@activity_collapsed}
            sessions_loading={@sessions_loading}
          />
        </div>
      </:tab_content>

      <%!-- Work Items Tab --%>
      <:tab_content tab="work">
        <div class="space-y-6 p-4 sm:p-6">
          <!-- Linear Tickets Panel -->
          <div class={[
            "panel-priority-high panel-accent-critical p-4 sm:p-6",
            @linear_collapsed && "panel-collapsed"
          ]}>
            <.live_component
              module={LinearComponent}
              id={:linear}
              collapsed={@linear_collapsed}
              tickets_in_progress={@tickets_in_progress}
            />
          </div>
          
<!-- Chainlink Issues Panel -->
          <div class={[
            "panel-priority-high panel-accent-critical p-4 sm:p-6",
            @chainlink_collapsed && "panel-collapsed",
            DashboardPhoenix.PanelStatus.status_classes(:chainlink, %{
              error: @chainlink_error,
              loading: @chainlink_loading,
              issues: @chainlink_issues,
              work_in_progress: @chainlink_work_in_progress
            })
          ]}>
            <.live_component
              module={ChainlinkComponent}
              id="chainlink-issues"
              collapsed={@chainlink_collapsed}
              work_in_progress={@chainlink_work_in_progress}
            />
          </div>
          
<!-- Work River -->
          <.live_component
            module={WorkRiverComponent}
            id="work-river"
            work_river_collapsed={@work_river_collapsed}
            linear_tickets={@linear_tickets}
            chainlink_issues={@chainlink_issues}
            tickets_in_progress={@tickets_in_progress}
            chainlink_work_in_progress={@chainlink_work_in_progress}
            agent_sessions={@agent_sessions}
            opencode_sessions={@opencode_sessions}
            show_completed={@show_completed}
            dismissed_sessions={@dismissed_sessions}
            work_registry_entries={@work_registry_entries}
            github_prs={@github_prs}
            pr_verifications={@pr_verifications}
          />
        </div>
      </:tab_content>

      <%!-- PRs & Branches Tab --%>
      <:tab_content tab="prs">
        <div class="space-y-6 p-4 sm:p-6">
          <!-- GitHub Pull Requests Panel -->
          <div class={[
            "panel-priority-high panel-accent-critical p-4 sm:p-6",
            @prs_collapsed && "panel-collapsed",
            DashboardPhoenix.PanelStatus.status_classes(:github_prs, %{
              error: @github_prs_error,
              loading: @github_prs_loading,
              prs: @github_prs,
              verifications: @pr_verifications
            })
          ]}>
            <.live_component
              module={PRsComponent}
              id="prs-panel"
              github_prs={@github_prs}
              github_prs_count={@github_prs_count}
              github_prs_loading={@github_prs_loading}
              github_prs_error={@github_prs_error}
              github_prs_last_updated={@github_prs_last_updated}
              prs_collapsed={@prs_collapsed}
              prs_in_progress={@prs_in_progress}
              pr_verifications={@pr_verifications}
              pr_fix_pending={@pr_fix_pending}
            />
          </div>
          
<!-- Unmerged Branches Panel -->
          <div class={[
            "panel-priority-medium panel-accent-active p-4 sm:p-6",
            @branches_collapsed && "panel-collapsed",
            DashboardPhoenix.PanelStatus.status_classes(:branches, %{
              error: @branches_error,
              loading: @branches_loading,
              branches: @unmerged_branches
            })
          ]}>
            <.live_component
              module={BranchesComponent}
              id="branches-panel"
              unmerged_branches={@unmerged_branches}
              unmerged_branches_count={@unmerged_branches_count}
              branches_loading={@branches_loading}
              branches_error={@branches_error}
              branches_last_updated={@branches_last_updated}
              branches_collapsed={@branches_collapsed}
              branch_merge_pending={@branch_merge_pending}
              branch_delete_pending={@branch_delete_pending}
            />
          </div>
        </div>
      </:tab_content>

      <%!-- Agents Tab --%>
      <:tab_content tab="agents">
        <div class="space-y-6 p-4 sm:p-6">
          <!-- Dave Panel -->
          <div class={[
            "panel-priority-high panel-accent-active p-4 sm:p-6",
            @dave_collapsed && "panel-collapsed"
          ]}>
            <.live_component
              module={DaveComponent}
              id="dave-panel"
              agent_sessions={@agent_sessions}
              dave_collapsed={@dave_collapsed}
              sessions_loading={@sessions_loading}
            />
          </div>
          
<!-- Sub-Agents Panel -->
          <div class={[
            "panel-priority-medium p-4 sm:p-6",
            @subagents_collapsed && "panel-collapsed",
            DashboardPhoenix.PanelStatus.status_classes(:subagents, %{
              sessions: @agent_sessions
            })
          ]}>
            <.live_component
              module={SubagentsComponent}
              id="subagents-panel"
              agent_sessions={@agent_sessions}
              subagents_collapsed={@subagents_collapsed}
              dismissed_sessions={@dismissed_sessions}
              show_completed={@show_completed}
              sessions_loading={@sessions_loading}
            />
          </div>
          
<!-- OpenCode Sessions Panel -->
          <div class={[
            "panel-priority-compact panel-accent-reference p-4 sm:p-6",
            @opencode_collapsed && "panel-collapsed",
            DashboardPhoenix.PanelStatus.status_classes(:opencode, %{
              server_status: @opencode_server_status,
              sessions: @opencode_sessions
            })
          ]}>
            <.live_component
              module={OpenCodeComponent}
              id="opencode-panel"
              opencode_server_status={@opencode_server_status}
              opencode_sessions={@opencode_sessions}
              opencode_collapsed={@opencode_collapsed}
              opencode_loading={@opencode_loading}
            />
          </div>
          
<!-- Gemini CLI Panel -->
          <div class={[
            "panel-priority-medium p-4 sm:p-6",
            @gemini_collapsed && "panel-collapsed",
            DashboardPhoenix.PanelStatus.status_classes(:gemini, %{
              server_status: @gemini_server_status,
              output: @gemini_output
            })
          ]}>
            <.live_component
              module={GeminiComponent}
              id="gemini-panel"
              gemini_server_status={@gemini_server_status}
              gemini_output={@gemini_output}
              gemini_collapsed={@gemini_collapsed}
              gemini_loading={@gemini_loading}
            />
          </div>
        </div>
      </:tab_content>

      <%!-- System Tab --%>
      <:tab_content tab="system">
        <div class="space-y-6 p-4 sm:p-6">
          <!-- Config Panel -->
          <div class={[
            "panel-priority-compact panel-accent-reference p-4 sm:p-6",
            @config_collapsed && "panel-collapsed"
          ]}>
            <.live_component
              module={ConfigComponent}
              id="config-panel"
              config_collapsed={@config_collapsed}
              coding_agent_pref={@coding_agent_pref}
              agent_mode={@agent_mode}
              last_agent={@last_agent}
              claude_model={@claude_model}
              opencode_model={@opencode_model}
              opencode_server_status={@opencode_server_status}
              gemini_server_status={@gemini_server_status}
            />
          </div>
          
<!-- Test Runner Panel -->
          <div class={[
            "panel-priority-medium p-4 sm:p-6",
            @test_runner_collapsed && "panel-collapsed"
          ]}>
            <.live_component
              module={TestRunnerComponent}
              id="test-runner-panel"
              test_runner_collapsed={@test_runner_collapsed}
              test_running={@test_running}
            />
          </div>
          
<!-- System Processes Panel -->
          <div class={[
            "panel-priority-medium p-4 sm:p-6",
            @system_processes_collapsed && "panel-collapsed"
          ]}>
            <.live_component
              module={SystemProcessesComponent}
              id="system-processes-panel"
              coding_agents={@coding_agents}
              coding_agents_count={@coding_agents_count}
              coding_agents_collapsed={@coding_agents_collapsed}
              coding_agents_loading={@coding_agents_loading}
              recent_processes={@recent_processes}
              recent_processes_count={@recent_processes_count}
              processes_loading={@processes_loading}
              system_processes_collapsed={@system_processes_collapsed}
              process_relationships_collapsed={@process_relationships_collapsed}
              graph_data={@graph_data}
            />
          </div>
          
<!-- Usage Stats -->
          <div class={[
            "panel-priority-compact panel-accent-reference p-4 sm:p-6",
            DashboardPhoenix.PanelStatus.status_classes(:usage_stats, %{
              opencode: @usage_stats[:opencode] || %{},
              claude: @usage_stats[:claude] || %{}
            })
          ]}>
            <.live_component
              module={UsageStatsComponent}
              id="usage-stats"
              usage_stats={@usage_stats}
              stats_loading={@stats_loading}
            />
          </div>
        </div>
      </:tab_content>
    </.live_component>
  </div>
  
<!-- Modals (Always available) -->
  <.live_component
    module={WorkModalComponent}
    id={:work_modal}
    show_work_modal={@show_work_modal}
    work_ticket_id={@work_ticket_id}
    work_ticket_details={@work_ticket_details}
    work_ticket_loading={@work_ticket_loading}
    work_in_progress={@work_in_progress}
    work_sent={@work_sent}
    work_error={@work_error}
    coding_agent_pref={@coding_agent_pref}
    agent_mode={@agent_mode}
    last_agent={@last_agent}
    claude_model={@claude_model}
    opencode_model={@opencode_model}
    tickets_in_progress={@tickets_in_progress}
  />
  
<!-- Work Context Modal - Unified work item details (#125) -->
  <.live_component
    module={WorkContextModalComponent}
    id="work-context-modal"
    show_modal={@show_work_context_modal}
    selected_item={@selected_work_item}
    linear_tickets={@linear_tickets}
    chainlink_issues={@chainlink_issues}
    tickets_in_progress={@tickets_in_progress}
    chainlink_work_in_progress={@chainlink_work_in_progress}
    agent_sessions={@agent_sessions}
    opencode_sessions={@opencode_sessions}
    github_prs={@github_prs}
    pr_verifications={@pr_verifications}
  />
</div>
