<div class="min-h-screen flex flex-col" id="panel-state-container" phx-hook="PanelState">
  <!-- Compact Header -->
  <div class="glass-panel rounded-lg px-4 py-2 flex items-center justify-between mb-3">
    <div class="flex items-center space-x-4">
      <h1 class="text-sm font-bold tracking-widest text-base-content">SYSTEMATIC</h1>
      <span class="text-[10px] text-base-content/60 font-mono">AGENT CONTROL</span>
      
      <!-- Theme Toggle -->
      <button
        id="theme-toggle"
        phx-hook="ThemeToggle"
        class="p-1.5 rounded-lg bg-base-content/10 hover:bg-base-content/20 transition-colors"
        title="Toggle light/dark mode"
      >
        <svg class="sun-icon w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg class="moon-icon w-4 h-4 text-indigo-400" style="display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>
    </div>
    
    <!-- Compact Stats -->
    <div class="flex items-center space-x-6 text-xs font-mono">
      <div class="flex items-center space-x-2">
        <span class="text-base-content/50">Agents:</span>
        <span class="text-success font-bold"><%= @agent_sessions_count %></span>
      </div>
      <div class="flex items-center space-x-2">
        <span class="text-base-content/50">Events:</span>
        <span class="text-primary font-bold"><%= @agent_progress_count %></span>
      </div>
      <%= if @coding_agent_pref == :opencode do %>
        <div class="flex items-center space-x-2">
          <span class="text-base-content/50">ACP:</span>
          <%= if @opencode_server_status.running do %>
            <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
          <% else %>
            <span class="w-2 h-2 rounded-full bg-base-content/30"></span>
          <% end %>
        </div>
      <% end %>
      <div class="flex items-center space-x-1">
        <span class={"px-2 py-0.5 rounded text-[10px] " <> coding_agent_badge_class(@coding_agent_pref)}>
          <%= coding_agent_badge_text(@coding_agent_pref) %>
        </span>
      </div>
    </div>
  </div>

  <!-- Main Two-Column Layout -->
  <div class="flex-1 flex flex-col lg:flex-row gap-3 min-h-0">
    
    <!-- LEFT: Removed chat panel - use OpenClaw Control UI at https://balgownie.tail1b57dd.ts.net:8443/ -->

    <!-- Main Panels (full width, chat removed) -->
    <div class="w-full flex flex-col gap-3 overflow-y-auto">
      
      <!-- Usage Stats Panel (LiveComponent) -->
      <.live_component
        module={UsageStatsComponent}
        id="usage-stats"
        usage_stats={@usage_stats}
      />

      <!-- Linear Tickets Panel (LiveComponent) -->
      <.live_component
        module={LinearComponent}
        id="linear-tickets"
        linear_tickets={@linear_tickets}
        linear_counts={@linear_counts}
        linear_loading={@linear_loading}
        linear_error={@linear_error}
        linear_collapsed={@linear_collapsed}
        linear_status_filter={@linear_status_filter}
        tickets_in_progress={@tickets_in_progress}
      />

      <!-- Chainlink Issues Panel (LiveComponent) -->
      <.live_component
        module={ChainlinkComponent}
        id="chainlink-issues"
        chainlink_issues={@chainlink_issues}
        chainlink_loading={@chainlink_loading}
        chainlink_error={@chainlink_error}
        chainlink_collapsed={@chainlink_collapsed}
        chainlink_work_in_progress={@chainlink_work_in_progress}
      />

      <!-- GitHub Pull Requests Panel -->
      <.live_component
        module={PRsComponent}
        id="prs-panel"
        github_prs={@github_prs}
        github_prs_loading={@github_prs_loading}
        github_prs_error={@github_prs_error}
        github_prs_last_updated={@github_prs_last_updated}
        prs_collapsed={@prs_collapsed}
        prs_in_progress={@prs_in_progress}
        pr_verifications={@pr_verifications}
        pr_fix_pending={@pr_fix_pending}
      />

      <!-- Unmerged Branches Panel -->
      <.live_component
        module={BranchesComponent}
        id="branches-panel"
        unmerged_branches={@unmerged_branches}
        branches_loading={@branches_loading}
        branches_error={@branches_error}
        branches_last_updated={@branches_last_updated}
        branches_collapsed={@branches_collapsed}
        branch_merge_pending={@branch_merge_pending}
        branch_delete_pending={@branch_delete_pending}
      />

      <!-- OpenCode Sessions Panel (LiveComponent) -->
      <.live_component
        module={OpenCodeComponent}
        id="opencode-panel"
        opencode_server_status={@opencode_server_status}
        opencode_sessions={@opencode_sessions}
        opencode_collapsed={@opencode_collapsed}
      />

      <!-- Gemini CLI Panel (LiveComponent) -->
      <.live_component
        module={GeminiComponent}
        id="gemini-panel"
        gemini_server_status={@gemini_server_status}
        gemini_output={@gemini_output}
        gemini_collapsed={@gemini_collapsed}
      />

      <!-- Dave Panel (Main Agent) -->
      <.live_component
        module={DaveComponent}
        id="dave-panel"
        agent_sessions={@agent_sessions}
        dave_collapsed={@dave_collapsed}
      />

      <!-- Sub-Agents Panel -->
      <.live_component
        module={SubagentsComponent}
        id="subagents-panel"
        agent_sessions={@agent_sessions}
        subagents_collapsed={@subagents_collapsed}
        dismissed_sessions={@dismissed_sessions}
        show_completed={@show_completed}
      />

      <!-- Live Progress Panel (LiveComponent) -->
      <.live_component
        module={LiveProgressComponent}
        id="live-progress-panel"
        live_progress_collapsed={@live_progress_collapsed}
        agent_progress_count={@agent_progress_count}
        progress_events={@streams.progress_events}
      />
    </div>
  </div>

  <!-- Bottom Panels Row (Less Important - Collapsed by Default) -->
  <div class="mt-3 space-y-2">
    
    <!-- Config Panel (LiveComponent) -->
    <.live_component
      module={ConfigComponent}
      id="config-panel"
      config_collapsed={@config_collapsed}
      coding_agent_pref={@coding_agent_pref}
      claude_model={@claude_model}
      opencode_model={@opencode_model}
      opencode_server_status={@opencode_server_status}
      gemini_server_status={@gemini_server_status}
    />

    <!-- System Processes Panel (LiveComponent) -->
    <.live_component
      module={SystemProcessesComponent}
      id="system-processes-panel"
      coding_agents={@coding_agents}
      coding_agents_count={@coding_agents_count}
      coding_agents_collapsed={@coding_agents_collapsed}
      recent_processes={@recent_processes}
      recent_processes_count={@recent_processes_count}
      system_processes_collapsed={@system_processes_collapsed}
      process_relationships_collapsed={@process_relationships_collapsed}
      graph_data={@graph_data}
    />
  </div>

  <!-- Work on Ticket Modal -->
  <%= if @show_work_modal do %>
    <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" phx-click="close_work_modal">
      <div class="glass-panel rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto" phx-click-away="close_work_modal">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <span class="text-2xl">ðŸŽ«</span>
            <h2 class="text-lg font-bold text-white font-mono"><%= @work_ticket_id %></h2>
          </div>
          <button phx-click="close_work_modal" class="text-base-content/60 hover:text-white text-xl">âœ•</button>
        </div>
        
        <!-- Ticket Details -->
        <div class="mb-6">
          <div class="text-xs font-mono text-accent uppercase tracking-wider mb-2">Ticket Details</div>
          <%= if @work_ticket_loading do %>
            <div class="flex items-center space-x-2 text-base-content/60">
              <span class="throbber"></span>
              <span class="text-sm">Fetching ticket details...</span>
            </div>
          <% else %>
            <pre class="text-xs font-mono text-base-content/80 bg-black/40 rounded-lg p-4 whitespace-pre-wrap overflow-x-auto max-h-64 overflow-y-auto"><%= @work_ticket_details %></pre>
          <% end %>
        </div>
        
        <!-- Execute Work -->
        <div class="border-t border-white/10 pt-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-xs font-mono text-accent uppercase tracking-wider">Start Working</div>
            <div class={"text-[10px] font-mono px-2 py-1 rounded " <> coding_agent_badge_class(@coding_agent_pref)}>
              Using: <%= coding_agent_badge_text(@coding_agent_pref) %>
            </div>
          </div>
          
          <%= if @work_error do %>
            <div class="bg-error/20 text-error rounded-lg p-3 text-sm font-mono mb-3"><%= @work_error %></div>
          <% end %>
          
          <div class="flex items-center space-x-3">
            <button
              phx-click="execute_work"
              disabled={@work_in_progress or @work_ticket_loading or @work_sent}
              class={"flex-1 py-3 rounded-lg text-sm font-mono font-bold transition-all " <> 
                cond do
                  @work_sent -> "bg-green-500/30 text-green-300"
                  @work_in_progress -> "bg-blue-500/30 text-blue-300 cursor-wait"
                  true -> "bg-accent/20 text-accent hover:bg-accent/40"
                end}
            >
              <%= cond do %>
                <% @work_sent -> %>âœ“ Work Started
                <% @work_in_progress -> %><span class="inline-block animate-spin mr-2">âŸ³</span> Starting...
                <% true -> %>ðŸš€ Execute Work
              <% end %>
            </button>
            <a 
              href={"https://linear.app/fresh-clinics/issue/#{@work_ticket_id}"} 
              target="_blank"
              class="px-4 py-3 rounded-lg bg-base-content/10 text-base-content/70 hover:bg-base-content/20 text-sm font-mono"
            >
              Linear â†—
            </a>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
